/*! j-toker - v0.0.11-alpha1 - 2021-06-21
* Copyright (c) 2021 Lynn Dylan Hurley; Licensed WTFPL */

!function(e){"function"==typeof define&&define.amd?define(["jquery","jquery-deparam","pubsub-js","jquery.cookie"],e):"object"==typeof exports?module.exports=e(require("jquery"),require("jquery-deparam"),require("pubsub-js"),require("jquery.cookie")):e(window.jQuery,window.deparam,window.PubSub)}(function(s,o,r){var n=Function("return this")();if(n.auth)return n.auth;function e(){this.configured=!1,this.configDfd=null,this.configs={},this.defaultConfigKey=null,this.firstTimeLogin=!1,this.mustResetPassword=!1,this.user={},this.oAuthDfd=null,this.oAuthTimer=null,this.configBase={additionalApiRequestUrls:[],apiUrl:"/api",signOutPath:"/auth/sign_out",emailSignInPath:"/auth/sign_in",emailRegistrationPath:"/auth",accountUpdatePath:"/auth",accountDeletePath:"/auth",passwordResetPath:"/auth/password",passwordUpdatePath:"/auth/password",tokenValidationPath:"/auth/validate_token",proxyIf:function(){return!1},proxyUrl:"/proxy",forceHardRedirect:!1,storage:"cookies",cookieExpiry:14,cookiePath:"/",initialCredentials:null,passwordResetSuccessUrl:function(){return n.location.href},confirmationSuccessUrl:function(){return n.location.href},tokenFormat:{"access-token":"{{ access-token }}","token-type":"Bearer",client:"{{ client }}",expiry:"{{ expiry }}",uid:"{{ uid }}"},parseExpiry:function(e){return 1e3*parseInt(e.expiry,10)||null},handleLoginResponse:function(e){return e.data},handleAccountUpdateResponse:function(e){return e.data},handleTokenValidationResponse:function(e){return e.data},authProviderPaths:{github:"/auth/github",facebook:"/auth/facebook",google:"/auth/google_oauth2"}}}function a(t){return[n.auth.getApiUrl()].concat(n.auth.configs.additionalApiRequestUrls).some(function(e){return null!==t.match(e)})}function i(e,o){function t(e,t){return void 0===o[t]?e:o[t]}for(var r=new RegExp("{{\\s*([a-z0-9-_]+)\\s*}}","ig"),i="";i!==e;e=(i=e).replace(r,t));return e}function u(e){return e&&e.replace(/("|')/g,"")}var c=n.navigator,h="default",d="currentConfigName",f="authHeaders",l="firstTimeLogin",p="mustResetPassword",g="auth.validation.success",t="auth.validation.error",m="auth.oAuthSignIn.error",v="auth.signIn.success",y="auth.signIn.error";return e.prototype.reset=function(){for(var e in this.destroySession(),this.configs={},this.defaultConfigKey=null,this.configured=!1,this.configDfd=null,this.mustResetPassword=!1,this.firstTimeLogin=!1,this.oAuthDfd=null,this.willRedirect=!1,this.oAuthTimer&&(clearTimeout(this.oAuthTimer),this.oAuthTimer=null),this.user)delete this.user[e];s(document).unbind("ajaxComplete",this.updateAuthCredentials),n.removeEventListener&&n.removeEventListener("message",this.handlePostMessage),s.ajaxSetup({beforeSend:void 0})},e.prototype.invalidateTokens=function(){for(var e in this.user)delete this.user[e];this.deleteData(d),this.deleteData(f)},e.prototype.checkDependencies=function(){var e=[],t=[];if(!s)throw"jToker: jQuery not found. This module depends on jQuery.";if(n.localStorage||s.cookie||e.push("This browser does not support localStorage. You must install jquery-cookie to use jToker with this browser."),o||e.push("Dependency not met: jquery-deparam."),r||t.push("jquery.ba-tinypubsub.js not found. No auth events will be broadcast."),e.length)throw"jToker: Please resolve the following errors: "+e.join(" ");t.length&&console&&console.warn&&(t=t.join(" "),console.warn("jToker: Warning: "+t))},e.prototype.destroySession=function(){var e,t=[f,d];for(e in t)if(e=t[e],n.localStorage&&n.localStorage.removeItem(e),s.cookie){for(var o in this.configs){o=this.configs[o].cookiePath;s.removeCookie(e,{path:o})}s.removeCookie(e,{path:"/"})}},e.prototype.configure=function(e,t){if(t&&this.reset(),this.configured)return this.configDfd;this.configured=!0,(e=e||{}).constructor!==Array&&(this.defaultConfigKey=h,(i={})[this.defaultConfigKey]=e,e=[i]);for(var o=0;o<e.length;o++){var r=function(e){for(var t in e)return t}(e[o]);this.defaultConfigKey||(this.defaultConfigKey=r),this.configs[r]=s.extend({},this.configBase,e[o][r])}if(this.checkDependencies(),s(document).ajaxComplete(n.auth.updateAuthCredentials),s.ajaxSetup({beforeSend:n.auth.appendAuthHeaders}),n.addEventListener&&n.addEventListener("message",this.handlePostMessage,!1),this.processSearchParams(),this.willRedirect)return!1;if(this.getConfig().initialCredentials){var i=this.getConfig();return this.persistData(f,i.initialCredentials.headers),this.persistData(p,i.initialCredentials.mustResetPassword),this.persistData(l,i.initialCredentials.firstTimeLogin),this.setCurrentUser(i.initialCredentials.user),(new s.Deferred).resolve(i.initialCredentials.user)}return this.configDfd=this.validateToken({config:this.getCurrentConfigName()}),this.configDfd},e.prototype.getApiUrl=function(){var e=this.getConfig();return e.proxyIf()?e.proxyUrl:e.apiUrl},e.prototype.buildAuthHeaders=function(e){var t,o={},r=this.getConfig().tokenFormat;for(t in r)o[t]=i(r[t],e);return o},e.prototype.setCurrentUser=function(e){for(var t in this.user)delete this.user[t];return s.extend(this.user,e),this.user.signedIn=!0,this.user.configName=this.getCurrentConfigName(),this.user},e.prototype.handlePostMessage=function(e){var t,o,r=!1;"deliverCredentials"===e.data.message&&(delete e.data.message,o=n.auth.normalizeTokenKeys(e.data),t=n.auth.buildAuthHeaders(o),o=n.auth.setCurrentUser(e.data),n.auth.persistData(f,t),n.auth.resolvePromise("auth.oAuthSignIn.success",n.auth.oAuthDfd,o),n.auth.broadcastEvent(v,o),n.auth.broadcastEvent(g,o),r=!0),"authFailure"===e.data.message&&(n.auth.rejectPromise(m,n.auth.oAuthDfd,e.data,"OAuth authentication failed."),n.auth.broadcastEvent(y,e.data),r=!0),r&&(clearTimeout(n.auth.oAuthTimer),n.auth.oAuthTimer=null)},e.prototype.normalizeTokenKeys=function(e){return e.token&&(e["access-token"]=e.token,delete e.token),e.auth_token&&(e["access-token"]=e.auth_token,delete e.auth_token),e.client_id&&(e.client=e.client_id,delete e.client_id),e.config&&(this.persistData(d,e.config,e.config),delete e.config),e},e.prototype.processSearchParams=function(){var e=this.getQs(),t=null;return(e=this.normalizeTokenKeys(e))["access-token"]&&e.uid&&(t=this.buildAuthHeaders(e),this.persistData(f,t),e.reset_password&&this.persistData(p,!0),e.account_confirmation_success&&this.persistData(l,!0),e=this.getLocationWithoutParams(["access-token","token","auth_token","config","client","client_id","expiry","uid","reset_password","account_confirmation_success"]),this.willRedirect=!0,this.setLocation(e)),t},e.prototype.getLocationWithoutParams=function(e){var t=s.param(this.stripKeys(this.getSearchQs(),e)),o=s.param(this.stripKeys(this.getAnchorQs(),e)),e=n.location.hash.split("?")[0],t=t&&"?"+t;return o&&(e+="?"+o),e&&!e.match(/^#/)&&(e="#/"+e),n.location.protocol+"//"+n.location.host+n.location.pathname+t+e},e.prototype.stripKeys=function(e,t){for(var o in t)delete e[t[o]];return e},e.prototype.broadcastEvent=function(e,t){r.publish&&r.publish(e,t)},e.prototype.resolvePromise=function(e,t,o){var r=this,i=s.Deferred();return setTimeout(function(){r.broadcastEvent(e,o),t.resolve(o),i.resolve()},0),i.promise()},e.prototype.rejectPromise=function(e,t,o,r){var i=this;return o=s.parseJSON(o&&o.responseText||"{}"),setTimeout(function(){i.broadcastEvent(e,o),t.reject({reason:r,data:o})},0),t},e.prototype.validateToken=function(e){if((e=e||{}).config||(e.config=this.getCurrentConfigName()),this.configDfd)return this.configDfd;var o,r=s.Deferred();return this.retrieveData(f)?(o=this.getConfig(e.config),e=this.getApiUrl()+o.tokenValidationPath,s.ajax({url:e,context:this,success:function(e){var t=o.handleTokenValidationResponse(e);this.setCurrentUser(t),this.retrieveData(l)&&(this.broadcastEvent("auth.emailConfirmation.success",e),this.persistData(l,!1),this.firstTimeLogin=!0),this.retrieveData(p)&&(this.broadcastEvent("auth.passwordResetConfirm.success",e),this.persistData(p,!1),this.mustResetPassword=!0),this.resolvePromise(g,r,this.user)},error:function(e){this.invalidateTokens(),this.retrieveData(l)&&(this.broadcastEvent("auth.emailConfirmation.error",e),this.persistData(l,!1)),this.retrieveData(p)&&(this.broadcastEvent("auth.passwordResetConfirm.error",e),this.persistData(p,!1)),this.rejectPromise(t,r,e,"Cannot validate token; token rejected by server.")}})):(this.invalidateTokens(),this.rejectPromise(t,r,{},"Cannot validate token; no token found.")),r.promise()},e.prototype.emailSignUp=function(e){var t=this.getConfig((e=e||{}).config),o=this.getApiUrl()+t.emailRegistrationPath,r=s.Deferred();return e.config_name=e.config,delete e.config,e.confirm_success_url=t.confirmationSuccessUrl(),s.ajax({url:o,context:this,method:"POST",data:e,success:function(e){this.resolvePromise("auth.emailRegistration.success",r,e)},error:function(e){this.rejectPromise("auth.emailRegistration.error",r,e,"Failed to submit email registration.")}}),r.promise()},e.prototype.emailSignIn=function(e){var o=this.getConfig((e=e||{}).config),t=this.getApiUrl()+o.emailSignInPath,r=s.Deferred();return delete e.config,s.ajax({url:t,context:this,method:"POST",data:e,success:function(e){var t=o.handleLoginResponse(e);this.setCurrentUser(t),this.resolvePromise("auth.emailSignIn.success",r,e),this.broadcastEvent(v,t),this.broadcastEvent(g,this.user)},error:function(e){this.rejectPromise("auth.emailSignIn.error",r,e,"Invalid credentials."),this.broadcastEvent(y,e)}}),r.promise()},e.prototype.listenForCredentials=function(e){var t=this;e.closed?t.rejectPromise(m,t.oAuthDfd,null,"OAuth window was closed bofore registration was completed."):(e.postMessage("requestCredentials","*"),t.oAuthTimer=setTimeout(function(){t.listenForCredentials(e)},500))},e.prototype.openAuthWindow=function(e){this.getConfig().forceHardRedirect||n.isIE()?this.setLocation(e):(e=this.createPopup(e),this.listenForCredentials(e))},e.prototype.buildOAuthUrl=function(e,t,o){var r=this.getConfig().apiUrl+o+"?auth_origin_url="+encodeURIComponent(n.location.href)+"&config_name="+encodeURIComponent(e||this.getCurrentConfigName())+"&omniauth_window_type=newWindow";if(t)for(var i in t)r+="&",r+=encodeURIComponent(i),r+="=",r+=encodeURIComponent(t[i]);return r},e.prototype.oAuthSignIn=function(e){if(!(e=e||{}).provider)throw"jToker: provider param undefined for `oAuthSignIn` method.";var t=this.getConfig(e.config).authProviderPaths[e.provider],o=this.buildOAuthUrl(e.config,e.params,t);if(!t)throw"jToker: providerPath not found for provider: "+e.provider;return this.oAuthDfd=s.Deferred(),this.openAuthWindow(o),this.oAuthDfd.promise()},e.prototype.signOut=function(e){var e=this.getConfig((e=e||{}).config),e=this.getApiUrl()+e.signOutPath,t=s.Deferred();return s.ajax({url:e,context:this,method:"DELETE",success:function(e){this.resolvePromise("auth.signOut.success",t,e)},error:function(e){this.rejectPromise("auth.signOut.error",t,e,"Failed to sign out.")},complete:function(){this.invalidateTokens()}}),t.promise()},e.prototype.updateAccount=function(e){var o=this.getConfig((e=e||{}).config),t=this.getApiUrl()+o.accountUpdatePath,r=s.Deferred();return delete e.config,s.ajax({url:t,context:this,method:"PUT",data:e,success:function(e){var t=o.handleAccountUpdateResponse(e);this.setCurrentUser(t),this.resolvePromise("auth.accountUpdate.success",r,e)},error:function(e){this.rejectPromise("auth.accountUpdate.error",r,e,"Failed to update user account")}}),r.promise()},e.prototype.destroyAccount=function(e){var e=this.getConfig((e=e||{}).config),e=this.getApiUrl()+e.accountDeletePath,t=s.Deferred();return s.ajax({url:e,context:this,method:"DELETE",success:function(e){this.invalidateTokens(),this.resolvePromise("auth.destroyAccount.success",t,e)},error:function(e){this.rejectPromise("auth.destroyAccount.error",t,e,"Failed to destroy user account")}}),t.promise()},e.prototype.requestPasswordReset=function(e){if(void 0===(e=e||{}).email)throw"jToker: email param undefined for `requestPasswordReset` method.";var t=this.getConfig(e.config),o=this.getApiUrl()+t.passwordResetPath,r=s.Deferred();return e.config_name=e.config,delete e.config,e.redirect_url=t.passwordResetSuccessUrl(),s.ajax({url:o,context:this,method:"POST",data:e,success:function(e){this.resolvePromise("auth.passwordResetRequest.success",r,e)},error:function(e){this.rejectPromise("auth.passwordResetRequest.error",r,e,"Failed to submit email registration.")}}),r.promise()},e.prototype.updatePassword=function(e){var t=this.getConfig((e=e||{}).config),t=this.getApiUrl()+t.passwordUpdatePath,o=s.Deferred();return delete e.config,s.ajax({url:t,context:this,method:"PUT",data:e,success:function(e){this.resolvePromise("auth.passwordUpdate.success",o,e)},error:function(e){this.rejectPromise("auth.passwordUpdate.error",o,e,"Failed to update password.")}}),o.promise()},e.prototype.persistData=function(e,t,o){t=JSON.stringify(t),"localStorage"===this.getConfig(o).storage?n.localStorage.setItem(e,t):s.cookie(e,t,{expires:this.getConfig(o).cookieExpiry,path:this.getConfig(o).cookiePath})},e.prototype.retrieveData=function(e){var t=null,t="localStorage"===this.getConfig().storage?n.localStorage.getItem(e):s.cookie(e);try{return s.parseJSON(t)}catch(e){return u(t)}},e.prototype.getCurrentConfigName=function(){var e=null;return this.getQs().config&&(e=this.getQs().config),s.cookie&&!e&&(e=s.cookie(d)),e=(e=n.localStorage&&!e?n.localStorage.getItem(d):e)||this.defaultConfigKey||h,u(e)},e.prototype.deleteData=function(e){"cookies"===this.getConfig().storage?s.removeCookie(e,{path:this.getConfig().cookiePath}):n.localStorage.removeItem(e)},e.prototype.getConfig=function(e){if(!this.configured)throw"jToker: `configure` must be run before using this plugin.";return e=e||this.getCurrentConfigName(),this.configs[e]},e.prototype.appendAuthHeaders=function(e,t){var o=n.auth.retrieveData(f);if(a(t.url)&&o)for(var r in e.setRequestHeader("If-Modified-Since","Mon, 26 Jul 1997 05:00:00 GMT"),n.auth.getConfig().tokenFormat)e.setRequestHeader(r,o[r])},e.prototype.updateAuthCredentials=function(e,t,o){if(a(o.url)){var r,i={},s=!0;for(r in n.auth.getConfig().tokenFormat)i[r]=t.getResponseHeader(r),i[r]&&(s=!1);i["access-token"]&&!s&&n.auth.persistData(f,i)}},e.prototype.getRawSearch=function(){return n.location.search},e.prototype.getRawAnchor=function(){return n.location.hash},e.prototype.setRawAnchor=function(e){n.location.hash=e},e.prototype.getAnchorSearch=function(){var e=this.getRawAnchor().split("?");return 1<e.length?e[1]:null},e.prototype.setRawSearch=function(e){n.location.search=e},e.prototype.setSearchQs=function(e){return this.setRawSearch(s.param(e)),this.getSearchQs()},e.prototype.setAnchorQs=function(e){return this.setAnchorSearch(s.param(e)),this.getAnchorQs()},e.prototype.setLocation=function(e){n.location.replace(e)},e.prototype.createPopup=function(e){return n.open(e)},e.prototype.getSearchQs=function(){var e=this.getRawSearch().replace("?","");return e?o(e):{}},e.prototype.getAnchorQs=function(){var e=this.getAnchorSearch();return e?o(e):{}},e.prototype.getQs=function(){return s.extend(this.getSearchQs(),this.getAnchorQs())},n.isOldIE=function(){var e=!1,t=c.userAgent.toLowerCase();return e=t&&-1!==t.indexOf("msie")&&parseInt(t.split("msie")[1])<10?!0:e},n.isIE=function(){var e=n.isOldIE(),t=!!c.userAgent.match(/Trident.*rv\:11\./);return e||t},n.auth=s.auth=new e,n.auth});